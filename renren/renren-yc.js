(function(window){var Renren={options:{},init:function(options){this.options=merge.apply(null,append([{},this.options],arguments));XD.init(this.options)}},rrUrls={widget:"http://widget.renren.com/",rrstatic:"http://s.xnimg.cn/",apps:"http://apps.renren.com/",graph:"http://graph.renren.com/",graph_https:"https://graph.renren.com/",callback:"http://widget.renren.com/xd_callback.html",widgetOrigin:"http://widget.renren.com"};var overloadSetter=function(fn){return function(s,a,b){if(a==null){return s}if(typeof a!="string"){for(var k in a){fn.call(s,k,a[k])}}else{fn.call(s,a,b)}return s}},typeOf=function(item){if(item==null){return"null"}if(item instanceof String||typeof item=="string"){return"string"}if(item instanceof Array){return"array"}if(item.nodeName){if(item.nodeType==1){return"element"}if(item.nodeType==3){return(/\S/).test(item.nodeValue)?"textnode":"whitespace"}}else{if(typeof item.length=="number"){if(item.callee){return"arguments"}if("item" in item){return"collection"}}}return typeof item},guid=function(){return(Math.random()*(1<<30)).toString(36).replace(".","")},extend=overloadSetter(function(key,value){this[key]=value}),implement=overloadSetter(function(key,value){this.prototype[key]=value}),bind=function(fn,thisobj,args){return function(){if(!args&&!arguments.length){return fn.call(thisobj)}if(args&&arguments.length){return fn.apply(thisobj,args.concat(Array.from(arguments)))}return fn.apply(thisobj,args||arguments)}},cloneOf=function(item){switch(typeOf(item)){case"array":case"object":return clone(item);default:return item}},clone=function(original){if(typeOf(original)=="array"){var i=original.length,clone=new Array(i);while(i--){clone[i]=cloneOf(original[i])}return clone}else{if(typeOf(original)=="string"){return new String(original)}}var clone={};for(var key in original){clone[key]=cloneOf(original[key])}return clone},forEach=function(object,fn,bind){if(typeOf(object)=="array"){for(var i=0,l=object.length;i<l;i++){if(i in object){fn.call(bind,object[i],i,object)}}}else{for(var key in object){if(Object.prototype.hasOwnProperty.call(object,key)){fn.call(bind,object[key],key,object)}}}},indexOf=function(array,item,from){var len=array.length;for(var i=(from<0)?Math.max(0,len+from):from||0;i<len;i++){if(array[i]===item){return i}}return -1},mergeOne=function(source,key,current){switch(typeOf(current)){case"object":if(typeOf(source[key])=="object"){merge(source[key],current)}else{source[key]=clone(current)}break;case"array":source[key]=clone(current);break;default:source[key]=current}return source},merge=function(source,k,v){if(typeOf(k)=="string"){return mergeOne(source,k,v)}for(var i=1,l=arguments.length;i<l;i++){var object=arguments[i];for(var key in object){mergeOne(source,key,object[key])}}return source},combineOne=function(source,key,value){var st=typeOf(source[key]);switch(typeOf(value)){case"object":case"array":if(st=="object"){combine(source[key],value)}else{if(st=="array"){var array=clone(value);for(var i=0,l=array.length;i<l;i++){if(indexOf(source[key],array[i])==-1){source[key].push(array[i])}}}else{if(st=="null"){source[key]=clone(value)}}}break;default:if(st=="null"){source[key]=value}}return source},combine=function(source,k,v){if(typeOf(k)=="string"){return combineOne(source,k,v)}for(var i=1,l=arguments.length;i<l;i++){var object=arguments[i];for(var key in object){combineOne(source,key,object[key])}}return source},append=function(original){for(var i=1,l=arguments.length;i<l;i++){if(typeOf(original)=="array"){var atp=typeOf(arguments[i]);if(atp=="array"||atp=="arguments"){for(var j=0,lg=arguments[i].length;j<lg;j++){original.push(arguments[i][j])}}else{if(atp!="null"){original.push(arguments[i])}}}else{var extended=arguments[i]||{};for(var key in extended){original[key]=extended[key]}}}return original},parsePiece=function(key,val,base){var sliced=/([^\]]*)\[([^\]]*)\](.*)?/.exec(key);if(!sliced){base[key]=val;return}var prop=sliced[1],subp=sliced[2],others=sliced[3];if(!isNaN(subp)){var numVal=+subp;if(subp===numVal.toString(10)){subp=numVal}}base[prop]=base[prop]||(typeof subp=="number"?[]:{});if(others==null){base[prop][subp]=val}else{parsePiece(""+subp+others,val,base[prop])}},fromQueryString=function(qs){var decode=function(s){return decodeURIComponent(s.replace(/\+/g," "))},params={},parts=qs.split("&"),pair,val;for(var i=0;i<parts.length;i++){pair=parts[i].split("=",2);if(pair&&pair.length==2){val=decode(pair[1]);if(typeOf(val)=="string"){val=val.replace(/^\s+|\s+$/g,"");if(!isNaN(val)){numVal=+val;if(val===numVal.toString(10)){val=numVal}}}parsePiece(decode(pair[0]),val,params)}}return params},toQueryString=function(object,base){var queryString=[];forEach(object,function(value,key){if(base){key=base+"["+key+"]"}var result;switch(typeOf(value)){case"object":result=toQueryString(value,key);break;case"array":var qs={};forEach(value,function(val,i){qs[i]=val});result=toQueryString(qs,key);break;case"string":case"number":result=encodeURIComponent(key)+"="+encodeURIComponent(value);break}if(result&&value!=null){queryString.push(result)}});return queryString.join("&")},special={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},escape=function(chr){return special[chr]||"\\u"+("0000"+chr.charCodeAt(0).toString(16)).slice(-4)},validateJSON=function(string){string=string.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"");return(/^[\],:{}\s]*$/).test(string)},parseJSON=function(string){if(!string||typeOf(string)!="string"){return null}if(window.JSON&&window.JSON.parse){return window.JSON.parse(string)}if(!validateJSON(string)){throw new Error("Invalid JSON: "+string)}return eval("("+string+")")},toJSON=window.JSON&&window.JSON.stringify?function(obj){return window.JSON.stringify(obj)}:function(obj){if(obj&&obj.toJSON){obj=obj.toJSON()}switch(typeOf(obj)){case"string":return'"'+obj.replace(/[\x00-\x1f\\"]/g,escape)+'"';case"array":var string=[];forEach(obj,function(value,key){var json=toJSON(value);if(json){string.push(json)}});return"["+string+"]";case"object":var string=[];forEach(obj,function(value,key){var json=toJSON(value);if(json){string.push(toJSON(key)+":"+json)}});return"{"+string+"}";case"number":case"boolean":return""+obj;case"null":return"null"}return null};var Class=function(params){if(params instanceof Function){params={initialize:params}}var newClass=function(){reset(this);if(newClass.$prototyping){return this}this.$caller=null;var value=(this.initialize)?this.initialize.apply(this,arguments):this;this.$caller=this.caller=null;return value};Class.prototype.implement.call(newClass,params);newClass.constructor=Class;newClass.prototype.constructor=newClass;newClass.prototype.parent=parent;return newClass};var parent=function(){if(!this.$caller){throw new Error('The method "parent" cannot be called.')}var name=this.$caller.$name,parent=this.$caller.$owner.parent,previous=(parent)?parent.prototype[name]:null;if(!previous){throw new Error('The method "'+name+'" has no parent.')}return previous.apply(this,arguments)};var reset=function(object){for(var key in object){var value=object[key];switch(typeOf(value)){case"object":var F=function(){};F.prototype=value;object[key]=reset(new F());break;case"array":object[key]=clone(value);break}}return object};var wrap=function(self,key,method){if(method.$origin){method=method.$origin}var wrapper=function(){if(method.$protected&&this.$caller==null){throw new Error('The method "'+key+'" cannot be called.')}var caller=this.caller,current=this.$caller;this.caller=current;this.$caller=wrapper;var result=method.apply(this,arguments);this.$caller=current;this.caller=caller;return result};extend(wrapper,{$owner:self,$origin:method,$name:key});return wrapper};var implement=function(key,value,retain){if(Class.Mutators.hasOwnProperty(key)){value=Class.Mutators[key].call(this,value);if(value==null){return this}}if(typeof value=="function"){this.prototype[key]=(retain)?value:wrap(this,key,value)}else{merge(this.prototype,key,value)}return this};var getInstance=function(klass){klass.$prototyping=true;var proto=new klass;delete klass.$prototyping;return proto};var removeOn=function(string){return string.replace(/^on([A-Z])/,function(full,first){return first.toLowerCase()})};Class.overloadSetter=function(fn){return function(a,b){if(a==null){return this}if(typeof a!="string"){for(var k in a){fn.call(this,k,a[k])}}else{fn.call(this,a,b)}return this}};Class.prototype.implement=Class.overloadSetter(implement);Class.Mutators={Extends:function(parent){this.parent=parent;this.prototype=getInstance(parent)},Implements:function(items){forEach(items,function(item){var instance=new item;for(var key in instance){implement.call(this,key,instance[key],true)}},this)}};var Events=new Class({$events:{},addEvent:function(type,fn,internal){type=removeOn(type);this.$events[type]=(this.$events[type]||[]);if(indexOf(this.$events[type],fn)==-1){this.$events[type].push(fn)}if(internal){fn.internal=true}return this},addEvents:function(events){for(var type in events){this.addEvent(type,events[type])}return this},fireEvent:function(type,args,delay){type=removeOn(type);var events=this.$events[type];if(!events){return this}args=args||[];var t=typeOf(args);if(t!="array"&&t!="arguments"){args=[args]}forEach(events,function(fn){if(delay!=null){var self=this;window.setTimeout(function(){return fn.apply(self,args)},delay)}else{fn.apply(this,args)}},this);return this},removeEvent:function(type,fn){type=removeOn(type);var events=this.$events[type];if(events&&!fn.internal){var index=indexOf(events,fn);if(index!=-1){delete events[index]}}return this},removeEvents:function(events){var type;if(typeOf(events)=="object"){for(type in events){this.removeEvent(type,events[type])}return this}if(events){events=removeOn(events)}for(type in this.$events){if(events&&events!=type){continue}var fns=this.$events[type];for(var i=fns.length;i--;){if(i in fns){this.removeEvent(type,fns[i])}}}return this}});var Options=new Class({setOptions:function(){var options=this.options=merge.apply(null,append([{},this.options],arguments));if(this.addEvent){for(var option in options){if(typeof options[option]!="function"||!(/^on[A-Z]/).test(option)){continue}this.addEvent(option,options[option]);delete options[option]}}return this}});var Browser={getBrowser:function(){if(!Browser.browser){var ua=navigator.userAgent.toLowerCase(),platform=navigator.platform.toLowerCase(),UA=ua.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],mode=UA[1]=="ie"&&document.documentMode;Browser.browser={name:(UA[1]=="version")?UA[3]:UA[1],version:mode||parseFloat((UA[1]=="opera"&&UA[4])?UA[4]:UA[2]),platform:ua.match(/ip(?:ad|od|hone)/)?"ios":(ua.match(/(?:webos|android)/)||platform.match(/mac|win|linux/)||["other"])[0]}}return Browser.browser},getFlash:function(){if(!Browser.flash){var version="0 r0";try{version=navigator.plugins["Shockwave Flash"].description}catch(e){try{version=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(ex){}}version=version.match(/\d+/g);Browser.flash={version:Number(version[0]||"0."+version[1])||0,build:Number(version[2])||0}}return Browser.flash}};var Flash={url:rrUrls.rrstatic+"connect/swf/XdComm.swf",name:"RenrenXdSwf",callbacks:[],init:function(){if(Flash.inited){return}Flash.inited=true;var html=('<object type="application/x-shockwave-flash" id="'+Flash.name+'" data="'+Flash.url+'"'+(!!document.attachEvent?' name="'+Flash.name+'" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"':"")+' width="0" height="0"><param name="movie" value="'+Flash.url+'"></param><param name="allowScriptAccess" value="always"></param><param name="flashVars" value="onReady=Renren.onFlashReady"/></object>');Dom.appendHidden(html)},onFlashReady:function(){Flash.XdComm=document[Flash.name];for(var i=0,l=Flash.callbacks.length;i<l;i++){Flash.callbacks[i]()}Flash.callbacks=[]},hasMinVersion:function(){return Browser.getFlash().version>=9},onReady:function(cb){Flash.init();if(Flash.XdComm){window.setTimeout(function(){cb()},0)}else{Flash.callbacks.push(cb)}},initPostMessage:function(cb,origin){return Flash.XdComm.postMessage_init(cb,origin)},postMessage:function(message,targetOrigin){return Flash.XdComm.postMessage_send(message,targetOrigin)},sendXdHttpRequest:function(method,url,params,headers,callback,reqId){return Flash.XdComm.sendXdHttpRequest(method,url,params,headers,callback,reqId)}};var Dom={root:null,hiddenRoot:null,callbacks:{},append:function(content,root){if(!root){if(!Dom.root){Dom.root=document.getElementById("renren-root");if(!Dom.root){Dom.root=document.createElement("div");Dom.root.id="renren-root";(document.body||document.getElementsByTagName("body")[0]).appendChild(Dom.root)}}root=Dom.root}if(typeof content=="string"){var div=document.createElement("div");root.appendChild(div).innerHTML=content;return div}else{return root.appendChild(content)}},appendHidden:function(content){if(!Dom.hiddenRoot){var hiddenRoot=document.createElement("div"),style=hiddenRoot.style;style.positon="absolute";style.top="-10000px";style.width=style.height="0px";Dom.hiddenRoot=Dom.append(hiddenRoot)}return Dom.append(content,Dom.hiddenRoot)},onIframeReady:function(cbId){var cb=Dom.callbacks[cbId];cb&&cb()},insertIframe:function(opts){opts.id=opts.id||guid();opts.name=opts.name||guid();var srcSet=false,onloadDone=false;Dom.callbacks[opts.id]=function(){if(srcSet&&!onloadDone){onloadDone=true;opts.onload&&opts.onload(opts.root.firstChild);delete Dom.callbacks[opts.id]}};if(document.attachEvent){var html=('<iframe id="'+opts.id+'" name="'+opts.name+'"'+(opts.className?' class="'+opts.className+'"':"")+' style="border:none;'+(opts.width?"width:"+opts.width+"px;":"")+(opts.height?"height:"+opts.height+"px;":"")+'" src="'+opts.url+'" frameborder="0" scrolling="no" allowtransparency="true" onload="Renren.onIframeReady(\''+opts.id+"')\"></iframe>");opts.root.innerHTML='<iframe src="javascript:false" frameborder="0" scrolling="no" style="height:1px;"></iframe>';srcSet=true;window.setTimeout(function(){opts.root.innerHTML=html},0)}else{var node=document.createElement("iframe");node.id=opts.id;node.name=opts.name;node.onload=Dom.callbacks[opts.id];node.style.border="none";node.style.overflow="hidden";if(opts.className){node.className=opts.className}if(opts.height){node.style.height=opts.height+"px"}if(opts.width){node.style.width=opts.width+"px"}opts.root.appendChild(node);srcSet=true;node.src=opts.url}},postTarget:function(options){var form=document.createElement("form");form.action=options.url;form.target=options.target;form.method="POST";form.acceptCharset="utf-8";forEach(options.params,function(val,key){if(val!==null&&val!==undefined){var input=document.createElement("input");input.name=key;input.value=val;form.appendChild(input)}});Dom.appendHidden(form);try{form.submit()}finally{form.parentNode.removeChild(form)}},popupWindow:function(opts){var screenX=typeof window.screenX!="undefined"?window.screenX:window.screenLeft,screenY=typeof window.screenY!="undefined"?window.screenY:window.screenTop,outerWidth=typeof window.outerWidth!="undefined"?window.outerWidth:document.documentElement.clientWidth,outerHeight=typeof window.outerHeight!="undefined"?window.outerHeight:(document.documentElement.clientHeight-22),width=opts.width,height=opts.height,left=opts.left!=null?opts.left:parseInt(screenX+((outerWidth-width)/2),10),top=opts.top!=null?opts.top:parseInt(screenY+((outerHeight-height)/2.5),10),features=("width="+width+",height="+height+",left="+left+",top="+top),w=window.open(opts.url,opts.id,features);if(w&&opts.onload){opts.onload(w,opts.id)}return w},currentWindow:function(opts){window.location.href=opts.url;if(opts.onload){opts.onload(window)}return window},createUI:function(opts){if(opts.display==="page"){return Dom.currentWindow(opts)}if(opts.display!=="hidden"&&opts.display!=="iframe"){return Dom.popupWindow(opts)}var dialog=document.createElement("div"),dstyle=dialog.style;dstyle.position="absolute";dstyle.top="-10000px";dstyle.zIndex="10001";dstyle.height=opts.height+"px";dstyle.width=opts.width+"px";if(opts.display==="hidden"){dialog.className="rr_ui_hidden";opts.root=dialog;Dom.insertIframe(opts);Dom.append(dialog);return dialog}dialog.className="rr_ui_dialog";var bws=Browser.getBrowser();if(bws.name=="ie"&&bws.version<9){forEach(["top_left","top_right","bottom_left","bottom_right"],function(item){var span=document.createElement("span"),style=span.style,p=item.split("_");span.className="rr_dialog_"+item;style.height=style.width="10px";style.overflow="hidden";style.position="absolute";style.background="url("+rrUrls.rrstatic+"connect/img/dialog/pop_dialog_"+item+".png) no-repeat 0 0";style[p[0]]=style[p[1]]="-10px";dialog.appendChild(span)});forEach(["top","left","right","bottom"],function(item){var span=document.createElement("span"),style=span.style;span.className="rr_dialog_border_"+item;style.position="absolute";style.backgroundColor="rgb(82, 82, 82)";style.overflow="hidden";style.filter="alpha(opacity=70)";style.opacity="0.7";style[item]="-10px";if(item=="left"||item=="right"){style.width="10px";style.height="100%"}else{style.height="10px";style.width="100%"}dialog.appendChild(span)})}else{dstyle.padding="10px";dstyle.backgroundColor="rgba(82, 82, 82, 0.7)";dstyle.MozBorderRadius="8px";dstyle.borderRadius="8px"}var dialogContent=document.createElement("div"),cstyle=dialogContent.style;dialogContent.className="rr_dialog_content";cstyle.backgroundColor="#fff";cstyle.height=opts.height+"px";cstyle.width=opts.width+"px";opts.root=dialogContent;Dom.insertIframe(opts);dialog.appendChild(dialogContent);Dom.append(dialog);var view=Dom.getViewportInfo(),left=opts.left!=null?opts.left+(bws.name=="ie"?10:0):(view.scrollLeft+(view.width-opts.width-20)/2),top=opts.top!=null?opts.top+(bws.name=="ie"?10:0):(view.scrollTop+(view.height-opts.height-20)/2.5);dstyle.left=(left>0?left:0)+"px";dstyle.top=(top>0?top:0)+"px";return dialog},getViewportInfo:function(){var d=(document.documentElement&&document.compatMode=="CSS1Compat")?document.documentElement:document.body;return{scrollTop:d.scrollTop,scrollLeft:d.scrollLeft,width:self.innerWidth?self.innerWidth:d.clientWidth,height:self.innerHeight?self.innerHeight:d.clientHeight}}};var XD={origin:(location.protocol+"//"+location.host+"/"+guid()),transports:{fragment:"fragment",postMessage:window.postMessage?undefined:false},init:function(options){if(options&&options.originPath!=undefined){XD.origin=location.protocol+"//"+location.host+"/"+options.originPath}if(XD.transports.postMessage==undefined){var bws=Browser.getBrowser();if(bws.name=="ie"&&bws.version==8){XD.transports.postMessage=false}else{XD.PostMessage.init()}}if(!XD.transports.postMessage&&XD.transports.flash==undefined){XD.transports.flash=Flash.hasMinVersion()?0:false;XD.transports.flash===0&&XD.Flash.init()}},resolveRelation:function(relation){var pt,matches,parts=relation.split("."),node=window;for(var i=0,l=parts.length;i<l;i++){pt=parts[i];if(pt=="opener"||pt=="parent"||pt=="top"){node=node[pt]}else{if(matches=/^frames\[['"]?([a-zA-Z0-9-_]+)['"]?\]$/.exec(pt)){node=node.frames[matches[1]]}else{throw new SyntaxError("Malformed value to resolve: "+relation)}}}return node},PostMessage:{init:function(){window.addEventListener?window.addEventListener("message",XD.PostMessage.receiveMessage,false):window.attachEvent("onmessage",XD.PostMessage.receiveMessage);XD.transports.postMessage="postMessage"},receiveMessage:function(event){XD.receiveMessage({data:event.data,origin:event.origin,source:event.source,transport:"postMessage"})},sendMessage:function(message,targetOrigin,targetWin){if(typeOf(message)!="string"){message=toQueryString(message)}targetWin.postMessage(message,targetOrigin)}},Flash:{init:function(){Flash.onReady(function(){XD.transports.flash=Flash.initPostMessage("Renren.XD.Flash.receiveMessage",XD.origin)?"flash":false})},receiveMessage:function(message){XD.receiveMessage(message)},sendMessage:function(message,targetOrigin){return Flash.postMessage(message,targetOrigin)}},Fragment:{magic:"rr_xd_fragment",sendMessage:function(message,targetOrigin,targetWin){if(targetOrigin&&targetOrigin.indexOf(targetWin.location.protocol+"//"+targetWin.location.host+"/")==0){targetWin.Renren.XD.receiveMessage({data:message})}}},receiveMessage:function(msg){if(typeOf(msg.data)=="string"){msg.data=fromQueryString(msg.data)}XD.fireEvent("receivedXDMessage",msg)},sendMessage:function(message,targetOrigin,transport,targetRelWin){if(targetOrigin&&transport&&transport.length>0){transport=transport.substr(0,1).toUpperCase()+transport.substr(1);try{if(typeof targetRelWin=="string"){targetRelWin=XD.resolveRelation(targetRelWin)}XD[transport]&&XD[transport].sendMessage(message,targetOrigin,targetRelWin)}catch(e){}}},dispatchLocationFragment:function(loc){loc=loc||location.toString();if(loc.indexOf("#")==-1){return}var fragment=loc.substr(loc.indexOf("#")+1),magicIndex=fragment.indexOf(XD.Fragment.magic),params=fromQueryString(fragment);if(magicIndex>0){document.documentElement.style.display="none"}params.origin&&XD.sendMessage(params,params.origin,params.transport,params.relation)}};XD.dispatchLocationFragment();extend(XD,new Events());var Request=new Class({Implements:[Events,Options],options:{url:"",params:{},headers:{Accept:"text/javascript, text/html, application/xml, text/xml, */*"},method:"POST",urlEncoded:true,encoding:"utf-8",noCache:false},initialize:function(options){this.setOptions(options);this.id=guid()},check:function(){if(!this.running){return true}return false},abort:function(response){if(!this.running){return this}this.running=false;this.response=response||{error:"request_abort",error_description:"unknown reason."};this.failure(this.response)},success:function(response){this.onSuccess(response)},onSuccess:function(){this.fireEvent("complete",arguments,0).fireEvent("success",arguments,0)},failure:function(response){this.onFailure(response)},onFailure:function(){this.fireEvent("complete",arguments,0).fireEvent("failure",arguments,0)}});var XDResponse={requests:{},handleXDMessages:function(msg){if(msg.data&&msg.data.rqid){var req=XDResponse.requests[msg.data.rqid];if(req&&req.xd){if(req.xd.transport!="fragment"&&(!msg.origin||msg.origin.indexOf(rrUrls.widgetOrigin)!=0)){return}req.handleResponse(msg.data)}}},addXDRequest:function(req){if(!XDResponse.requests[req.id]){XDResponse.requests[req.id]=req}},removeXDRequest:function(req){if(XDResponse.requests[req.id]){delete XDResponse.requests[req.id]}}};XD.addEvent("receivedXDMessage",XDResponse.handleXDMessages);Request.Page=new Class({Extends:Request,options:{method:"GET",params:{display:"page"}},initialize:function(options){this.parent(options);this.options.params.display=this.constructor.prototype.options.params.display},send:function(){if(!this.check()){return this}this.running=true;var params=this.options.params;if(!params.redirect_uri){params.redirect_uri=this.getRedirectUri()}this.fireEvent("request");this.ui=this.createUI();if(!this.ui){var err=new Error("can't create request UI.");err.name="UICreateError";throw err}return this},createUI:function(){var opts=this.options,method=opts.method,url=(method==="GET"?opts.url+(opts.url.indexOf("?")<0?"?":"&")+toQueryString(opts.params):"about:blank");if(method==="GET"){var bn=Browser.getBrowser().name,maxLgh=(bn=="ie"?2050:7600);if(url.length>maxLgh){var err=new Error("The length of request url maybe too long, use POST method instend.");err.name="UrlTooLongError";throw err}}var uiOpts=merge({url:url,id:this.id,display:this.constructor.prototype.options.params.display,onload:function(node,nodeName){if(method==="POST"){Dom.postTarget({url:opts.url,target:nodeName||node.name,params:opts.params})}}},opts.style);ui=Dom.createUI(uiOpts);return ui},getRedirectUri:function(){var uri=location.toString(),poundIndex=uri.indexOf("#");if(poundIndex>0){uri=uri.substr(0,poundIndex)}return uri}});Request.Iframe=new Class({Extends:Request.Page,options:{params:{display:"iframe"}},initialize:function(options){this.parent(options);var ts=XD.transports,self=this;this.xd={relation:"parent",transport:ts.postMessage||ts.flash||"fragment",origin:XD.origin};this.addEvents({request:function(){XDResponse.addXDRequest(self)},complete:function(){XDResponse.removeXDRequest(self)}})},handleResponse:function(data){this.closeUI();this.response=data;this.running=false;if(!data.error){this.success(this.response)}else{this.failure(this.response)}},getRedirectUri:function(){var opts=merge(this.xd,"rqid",this.id),trans=this.xd.transport,uri;if(trans=="postMessage"||trans=="flash"){uri=rrUrls.callback+"#"}else{uri=location.toString();var poundIndex=uri.indexOf("#");if(poundIndex>0){uri=uri.substr(0,poundIndex)}uri+="#"+XD.Fragment.magic+"&"}return uri+toQueryString(opts)},closeUI:function(){if(this.ui){this.ui.parentNode.removeChild(this.ui);this.ui=null}}});Request.Hidden=new Class({Extends:Request.Iframe,options:{params:{display:"hidden"}}});Request.Popup=new Class({Extends:Request.Iframe,options:{params:{display:"popup"}},initialize:function(options){this.parent(options);var ts=XD.transports;this.xd={relation:"opener",transport:ts.postMessage||ts.flash||"fragment",origin:XD.origin}},send:function(){var r=this.parent(),params=this.options.params;if(this.ui&&params.redirect_uri&&params.redirect_uri.indexOf(rrUrls.callback)==0){this.constructor.popupReqs[this.id]=this;this.constructor.popupMonitor()}return r},handleResponse:function(data){this.closeUI();this.response=data;this.running=false;if(!data.error){this.success(this.response)}else{this.failure(this.response)}},closeUI:function(){if(this.ui){this.ui.close();this.ui=null}}});extend(Request.Popup,{popupReqs:{},popupMonitor:function(){var monitor;for(var id in this.popupReqs){if(this.popupReqs.hasOwnProperty(id)&&this.popupReqs[id] instanceof this){try{var request=this.popupReqs[id];if(!request.ui){delete this.popupReqs[id]}else{if(request.ui.closed){window.setTimeout(function(){request.abort({error:"request_abort",error_description:"user close the popup window."})},10);request.ui=null;delete this.popupReqs[id]}else{monitor=true}}}catch(e){}}}if(monitor&&!this.monitorInterval){this.monitorInterval=window.setInterval(bind(arguments.callee,this),500)}else{if(!monitor&&this.monitorInterval){window.clearInterval(this.monitorInterval);this.monitorInterval=null}}}});var ui=function(options,cb){if(!options.url){throw new Error("The url argument must not be null.")}var url=options.url,url=(url.indexOf("http://")==0||url.indexOf("https://")==0)?url:(rrUrls.widget+"dialog/"+url);var p=/^(https?:\/\/[^\/]*\/)([^\/\?#]*\/)*([^\/\?#]*)/.exec(url);if(p==null||(rrUrls.widget!=p[1]&&rrUrls.graph!=p[1]&&rrUrls.graph_https!=p[1])){return}var reqOptns=combine({url:url,method:(options.method&&options.method.toUpperCase()==="POST"?"POST":"GET")},options,defaults[(p[3]||"").toLowerCase()],{display:"popup",style:{width:475,height:340},params:{app_id:rrUrls.widget==p[1]?Renren.options.appId:null,client_id:(rrUrls.graph==p[1]||rrUrls.graph_https==p[1])?Renren.options.appId:null},onComplete:cb});return(function(reqOpts){var display=reqOpts.display,request;if(display.length>0){display=display.substr(0,1).toUpperCase()+display.substr(1)}if(Request[display]){request=new Request[display](reqOpts)}if(!request){throw new Error("Fail to start an ui request, the display argument may be invalid.")}try{return request.send()}catch(e){if(options.fallback!==false){if(e.name=="UrlTooLongError"){reqOpts.method="POST";return arguments.callee(reqOpts)}else{if(e.name=="UICreateError"&&request instanceof Request.Popup){reqOpts.display="page";return arguments.callee(reqOpts)}}}throw e}})(reqOptns)};var defaults={authorize:{display:"page",style:{width:570,height:340}},request:{style:{width:600,height:550}}};var XDPC={Server:new Class({methods:{},initialize:function(methods,clientOrigins){XD.addEvent("receivedXDMessage",bind(this.handleXDMessages,this));if(methods){this.addMethods(methods,clientOrigins)}},addMethod:function(name,fn,orgns){if(!this.methods[name]){this.methods[name]=XDPC.proxy(name,fn,orgns&&typeOf(orgns)!="array"?[orgns]:orgns)}},addMethods:function(methods,clientOrgns){if(clientOrgns&&typeOf(clientOrgns)!="array"){clientOrgns=[clientOrgns]}var orgns=append([],clientOrgns);for(var name in methods){this.addMethod(name,methods[name],orgns)}},removeMethod:function(name){if(this.methods[name]){delete this.methods[name]}},handleXDMessages:function(msg){if(msg.data&&msg.data.method){var proxyMethod=this.methods[msg.data.method];if(proxyMethod){proxyMethod(msg)}}}}),proxy:function(name,fn,origins){return function(msg){if(origins&&origins.length>0&&!XDPC.checkOrigin(msg.origin,origins)){return}var r=fn.apply(null,fn.internal?msg:msg.data.args);if(msg.data.cbid){XD.sendMessage({result:r,cbid:msg.data.cbid},msg.origin,msg.transport,msg.source)}}},checkOrigin:function(orgn,origins){if(!orgn){return false}for(var i=0,l=origins.length;i<l;i++){if(origins[i].indexOf(orgn)==0||orgn.indexOf(origins[i])==0){return true}}return false},Client:new Class({callbacks:{},initialize:function(server){XD.addEvent("receivedXDMessage",bind(this.handleXDMessages,this));this.server=merge({},server)},handleXDMessages:function(msg){if(msg.data&&msg.data.cbid){var cb=this.callbacks[msg.data.cbid];if(cb&&this.checkOrigin(msg.origin)){delete this.callbacks[msg.data.cbid];cb(msg.data.result)}}},checkOrigin:function(origin){return XDPC.checkOrigin(origin,[this.server.origin])},call:function(name,args,callback){var ts=XD.transports,trans=ts.postMessage||ts.flash,tp=typeOf(args),cbid;if(!trans){return}if(callback){cbid=guid();this.callbacks[cbid]=callback}if(tp!="array"&&tp!="arguments"){args=[args]}XD.sendMessage({method:name,args:args,cbid:cbid},this.server.origin,trans,this.server.relation)}})};XDPC.EventsReceiver=new Class({Extends:XDPC.Server,Implements:[Events],initialize:function(senderOrigins){this.parent({fireXDEvent:bind(this.fireEvent,this)},senderOrigins)}});XDPC.EventsSender=new Class({Extends:XDPC.Client,fireXDEvent:function(type,args,delay){this.call("fireXDEvent",[type,args,delay])}});XDPC.CanvasClient=new Class({Extends:XDPC.Client,initialize:function(){var s=location.search,params=(s==""?{}:fromQueryString(s.substr(1)));this.parent({origin:rrUrls.apps+(params.xn_sig||""),relation:"parent"})}});window.Renren=extend(Renren,{onFlashReady:Flash.onFlashReady,onIframeReady:Dom.onIframeReady,XD:XD,Request:Request,XDPC:XDPC,ui:ui})})(window);